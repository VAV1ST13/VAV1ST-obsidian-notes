202305091836
***
[[00 VRChat]]
***
[[ResilienceVR IK - Bonding interactions]]
***
ResilienceVR - это социальное VR-приложение, которое я разрабатываю для экспериментов и повторений за пределами существующих платформ.
В этой статье я объясню, как работает мой первый эксперимент: включение возможности заставлять аватар IK реагировать на объекты и игроков, несмотря на задержку.

## Сетевой IK в существующих приложениях

В социальной виртуальной реальности пользователи связаны друг с другом в едином виртуальном пространстве, обычно создавая единое виртуальное представление самих себя (аватар).

В настоящее время существует два основных способа, с помощью которых социальные VR-приложения передают виртуальное представление игрока другим игрокам:
- Либо передавать положение бедра и повороты костей аватара, либо
- Передавать положение и повороты важнейших костей аватара (таких как голова и руки) или аппаратных трекеров.

Эти подходы имеют различные недостатки. 
При последнем подходе конечным пользователям потребовалось бы выполнить дополнительные вычисления, чтобы определить позы других игроков.

Несмотря на это, оба этих подхода приводят к большому объему данных, которые необходимо отправлять по сети, поэтому для масштабирования в зависимости от потребностей приложения необходимы дополнительные упрощения и оптимизации.

Как правило, в худшем случае, когда аватары каждого пользователя находятся в непосредственной близости в виртуальном пространстве, использование сети в таких приложениях может быть оценено **квадратом количества игроков**, поскольку данные о присоединении любого нового игрока должны быть отправлены всем остальным существующим игрокам в инстансе.

Без оптимизаций:

- *Удвоение количества игроков* 
  инстанс с 10 игроками будет **в 4 раза** обременительнее для сети, чем инстанс с 5 игроками.
- *Умножьте количество игроков на 10* 
  инстанс с 80 игроками будет в 100 раз более обременительным для сети, чем инстанс с 8 игроками.

Эта проблема масштабирования является основным мотиватором для многих методов оптимизации, поскольку передача нестатических данных в сеть может привести к серьезным финансовым затратам.

## Проблема с задержкой
Пользователи по-прежнему разделены задержкой, что в некоторых случаях может привести к большим задержкам между игроками - порядка от 200мс до 1сек.

Эти задержки ограничивают возможность игроков управлять своим аватаром в ответ на действия другого игрока. Попытка взяться за руки, потанцевать вместе или манипулировать объектом в виртуальном пространстве, которым также манипулирует другой игрок, визуально приводит к несоответствию из-за задержки.

## Связующие взаимодействия
Чтобы обеспечить частичное решение этой проблемы, ResilienceVR экспериментирует с подходом, который обеспечивает некоторую степень реактивного взаимодействия между игроками, но не все. Социальная виртуальная реальность имеет различные контексты, и тот, который меня особенно интересует, - это **связь между пользователями**. Предоставьте пользователям возможность держаться за руки и танцевать вместе, положив руки друг на друга.

Для наших целей мы сосредоточимся на том, что известно за пределами виртуальной реальности как “контроль над жертвами”, термин, который используется stage combat в области актерского мастерства. Разыгрывая сцену драки, актер, который является агрессором, на самом деле не контролирует жертву. Жертва сохраняет полную свободу передвижения. Это означает, что если актер действует, захватывая голову актера-жертвы, голова актера-жертвы может свободно перемещаться по желанию жертвы, а не агрессора.

В нашем случае человек, контролирующий чьи-то конечности, не является инициатором взаимодействия.

Контекст важен, поэтому этот эксперимент не фокусируется на других социальных взаимодействиях виртуальной реальности, где игроки вступают в конфронтацию друг с другом, таких как рукопашный бой или игра с оружием.

Взаимодействие, ориентированное на боевые действия, может вызвать дополнительные проблемы, такие как требование от игрока способности брать под контроль конечности другого игрока, поскольку игроки, участвующие в бою, в этом контексте будут вести себя конфронтационно. Что случилось бы с вашей рукой, если бы кто-то другой схватил вас за локоть? “сетевой Boneworks” были бы совершенно другой проблемой для решения. Это могло бы стать предметом для будущего эксперимента в ResilienceVR.

## Взаимодействие с неигровыми игроками
Несмотря на то, что эта система была в первую очередь разработана для установления связей между игроками, так уж получилось, что система может быть легко расширена, чтобы обеспечить взаимодействие с предметами и обьектами в виртуальном пространстве и даже с предметами, находящимися в руках других игроков.

Сильно вдохновленная однопользовательскими играми, такими как Boneworks и Half-Life: Alyx, функция была расширена, чтобы рука игрока притягивалась к объектам и это притяжение было видно другим игрокам без задержек.

Следует отметить, что это рудиментарная форма взаимодействия, поскольку в отличие от однопользовательских игр здесь нет симуляции твердого тела или столкновений.

## Как это делается
Короче говоря, местные руки игрока сообщают другим игрокам, если они что-то притягивают. 
В момент захвата он сообщает другим игрокам, где они это схватили. Это не непрерывная передача данных.

Затем каждый игрок вычисляет, насколько сильно рука каждого игрока притягивается к соответствующим объектам, и запускает частичный IK-решатель, чтобы поместить свою руку где-то между их сетевым расположением руки IK и расположением руки объекта; чем сильнее она притягивается, тем ближе она находится.

В деталях:
### Шаг 1: Локальный пользователь сохраняет позу игрока для сетевого IK
Запускается обычный решатель IK, и решенная поза сохраняется, чтобы ее можно было отправить как часть сетевого IK. Сетевые позы IK всегда отправляются с локальными данными в конфигурации, как если бы вся система, описанная ниже в следующих шагах, не существовала.

Все аватары пользователей позируют на основе сетевого IK.

### Шаг 2: локальный пользователь находит наиболее привлекательный объект
В локальном режиме рука игрока ищет вокруг себя объекты, которые могут ее привлечь (если она еще не схватила объект).

Для наших целей конечности игрока являются привлекательными объектами.

Как только рука находит доступные объекты, она рассчитывает, где рука будет расположена на объекте, если она будет полностью притянута к нему, учитывая текущее расположение руки.

Вычислив потенциальные места расположения рук, мы рассчитываем величину намагниченности для каждого потенциального места расположения руки, которая является скалярной оценкой того, насколько близко текущее место расположения руки к потенциальному месту расположения руки. Кроме того, некоторые объекты более привлекательны, чем другие.

Объект, имеющий наибольшую намагниченность, становится победителем.

- Если пользователя что-то притягивает, он отправляет информацию о том, какой объект его притягивает, другим пользователям. Объект представлен номером, который является идентификатором для привлекательных объектов.
- Если пользователь решает схватить этот объект, он отправляет положение и вращение руки относительно этого объекта. 
  Эти данные не обновляются после первоначального действия захвата *(за одним исключением, описанным позже)*.
- Если пользователя ничего не привлекает, пользователь посылает информацию о том, что его ничего не привлекает.

Преимущества такого способа в том, что он дешевый. Это зависит от события. 
Привлечение не всегда меняется, а количество отправляемых данных минимально. 
Интерполяция сетевых данных вне фазовых изменений практически не требуется.

Поскольку эти вычисления выполняются локально, нам не нужно запускать поиск привлекательных объектов у других игроков. 
Это может привести к задержке перехода в привлекательное состояние.

Величина намагниченности может быть повторно использована для управления пользовательским вводом: 
Если величина намагниченности больше определенного порога, то пользователь может взаимодействовать с объектом, например, для подъема.

Обратите внимание, что величина намагниченности не передается другим игрокам. Намагниченность будет пересчитана для каждого игрока, чтобы лучше учесть задержки.

## Шаг 3: Все пользователи выполняют частичную IK для пользователей, которые притягиваются.
Пользователи решают IK локально для всех привлекаемых пользователей, включая себя.

Решатель IK не будет выполняться локально для данного игрока:

- Когда данный игрок не виден, или
- Когда данный игрок ни к чему не притягивается, или
- Когда игрок притягивается к объекту, который отключен, или
- Когда игрок притягивается к объекту, расположенному на чьем-то аватаре, который скрыт (т.е. аниматор не обновляется, потому что он удален).

Это позволяет сэкономить на итерациях для пользователей, которым это не нужно.

ResilienceVR использует IK-решатель, написанный на заказ, который обеспечивает больший контроль над тем, какая часть IK может быть запущена и как она может быть запущена, так что он может выбрать только решение руки, основанное на текущей позе аватара.

Пользователь рассчитывает размещение руки на конкретном объекте, а затем рассчитывает величину намагниченности.

Эта величина намагниченности используется для интерполяции между сетевым расположением руки и окончательным расположением руки. Это приводит к тому, что рука притягивается к объекту, когда она приближается к нему локально, а не удаленно.

Есть два способа выполнения итераций:

- Запустить все итерации решателя для каждого пользователя отдельно, в том же порядке для всех игроков, или
- Выполнить одну итерацию решателя для каждого пользователя, затем применить позу для каждого пользователя, затем снова выполнить итерацию.

Оба варианта имеют свои недостатки. В сценарии, где каждый пользователь решает схватить руку другого, или пользователи решают схватить друг друга за локти, это может привести к проблемам стабильности, которые еще предстоит исследовать.

## Относительное движение (на шаге 2)
Я хочу позволить игроку перемещать свою схваченную руку, используя при этом сетевой IK.

Когда игрок решает инициировать это действие, он посылает другое сетевое событие, которое содержит:

- положение и вращение руки в момент, когда это действие было инициировано, и
- положение и вращение удерживаемого объекта в момент начала этого действия.

После этого данные никогда не обновляются, поэтому интерполяции не происходит. 
На этапе решателя мы будем рассматривать руку игрока как разность относительно объекта. 
Это позволит ему получить преимущества от плавности любого сетевого IK без необходимости заниматься интерполяцией на этом этапе.

Когда игроки решают прекратить это действие, они посылают новое действие захвата со свежеиспеченными позициями и вращениями.

## Реализация в VRChat
Мир Udon VRChat "ResilienceVR IK Demo" - это порт вышеописанной системы, приведенный в соответствие с допустимыми ограничениями платформы VRChat.

Текущее состояние Udon ограничено из-за медлительности выполнения, но достаточно хорошо для демонстрации этого достижения. Следует отметить, что это наивный порт с очень небольшим количеством оптимизаций, специфичных для Udon, поскольку я хотел сохранить минимальные изменения в коде по сравнению с ResilienceVR.

Несмотря на это, мне все равно пришлось отключить некоторые части IK-решателя для упрощения. Если бы это был родной проект Udon, я бы написал решатель более эффективно.

Поскольку VRChat не предоставляет ни доступа к сеткам аватара, ни доступа на запись к его костям, мир сам содержит модели аватаров как SkinnedMeshRenderers и перемещает их арматуру, создавая впечатление, что пользователь носит аватар.

Пьедестал аватара в мире обеспечивает правильность вращения и длины костей, а также работу аниматора, когда он виден. Если аниматор не запущен из-за отсутствия видимой сетки, Udon's VRCPlayerApi не вернет обновленные значения вращения костей.

Мир VRChat работает следующим образом:

## Шаг 1: Локальный пользователь сохраняет позу игрока для сетевого IK.
Позиции и вращения костей всех игроков (с помощью VRCPlayerApi) собираются и копируются в память. Эти позиции и вращения считываются и записываются несколько раз в процессе решения IK.

В отличие от ResilienceVR, поскольку за сетевую IK отвечает VRChat, нам не нужно беспокоиться ни о чем из этого, поскольку мир не может повлиять на передаваемые кости в будущем.

## Шаг 2: Локальный пользователь находит наиболее привлекательный объект
Эта часть почти идентична ResilienceVR, но использует ручную синхронизацию Удона для передачи событий с помощью 
[CyanPlayerObjectPool](https://cyanlaser.github.io/CyanPlayerObjectPool/). 
Событийный характер оригинала позволяет легко перенести его в Udon.

## Шаг 3: Все пользователи запускают частичный IK для привлеченных пользователей.
Udon не дает достаточного доступа к данным игроков, чтобы выполнить большинство оптимизаций.

В этом случае я ограничился следующим:

Пользователи решают IK локально для всех обратившихся пользователей, включая себя.

Решатель IK не будет выполняться локально для данного игрока:

- Когда данный игрок не носит правильный аватар
- Когда данный игрок ничем не привлекает внимание.

Мы можем определить, одет ли игрок в правильный аватар, измерив индивидуальные расстояния между бедрами, позвоночником, грудью и шеей. Это может привести к ложным срабатываниям, если на игроке надет оригинальный аватар той же модели.

Итерации игроков выполняются индивидуально, при этом позы применяются сразу. Это может привести к некоторым расхождениям, поскольку порядок выполнения может повлиять на результат.

Решенные позы затем применяются к костям арматур SkinnedMeshRenderers, расположенных в мире.

## Результат
В результате этого эксперимента был создан мир VRChat, где вы можете испытать его сами. Я хочу, чтобы моя работа вдохновила существующих пользователей социальной VR на желание и требование большего от их любимых платформ социальной VR.

ResilienceVR будет оставаться социальным VR-приложением, которое я могу использовать для итераций новых идей, которыми можно поделиться.

Еще многое предстоит исследовать, поскольку взаимодействие игрока с игроком создает множество интересных проблем с точки зрения пользовательского опыта. Я получил много отзывов, особенно по поводу взаимодействия захвата и силы намагничивания, над которыми я буду работать.

## Patreon
Спасибо всем моим сторонникам на Patreon, Pixiv Fanbox, а также тем, кто пользуется моими бесплатными инструментами на Booth!

Если вам нравятся мои работы и исследования, поддержите меня на [Patreon](https://www.patreon.com/vr_hai)!